<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RequestPropsInjecterTransformer.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Restheart</a> &gt; <a href="index.source.html" class="el_package">org.restheart.hal.metadata.singletons</a> &gt; <span class="el_source">RequestPropsInjecterTransformer.java</span></div><h1>RequestPropsInjecterTransformer.java</h1><pre class="source lang-java linenums">/*
 * RESTHeart - the data REST API server
 * Copyright (C) SoftInstigate Srl
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 * 
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.restheart.hal.metadata.singletons;

import com.mongodb.BasicDBList;
import com.mongodb.BasicDBObject;
import com.mongodb.DBObject;
import io.undertow.attribute.ExchangeAttributes;
import io.undertow.server.HttpServerExchange;
import java.time.Instant;
import java.util.HashMap;
import java.util.Objects;
import org.bson.BSONObject;
import org.restheart.handlers.RequestContext;
import org.restheart.utils.JsonUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 *
 * @author Andrea Di Cesare &lt;andrea@softinstigate.com&gt;
 *
 * this transformer adds properties to the resource representation. usually it
 * is applied on REQUEST phase to store properties evaluated server side
 *
 * the properties to add are passed in the args argumenet
 *
 * ags can be an array of strings, each specifiying the names of the properties
 * to add or an object with a single property of an array of strings. in the
 * latter case, the properties are added to the representation nested in the
 * passed object property key.
 *
 * the properties that can be added are: userName, userRoles, dateTime, localIp,
 * localPort, localServerName, queryString, relativePath, remoteIp,
 * requestMethod, requestProtocol
 *
 * &lt;br&gt;for instance, with the following definition:
 * &lt;br&gt;{name:&quot;addRequestProperties&quot;, &quot;phase&quot;:&quot;REQUEST&quot;, &quot;scope&quot;:&quot;CHILDREN&quot;,
 * args:{&quot;log&quot;: [&quot;userName&quot;, &quot;remoteIp&quot;]}}
 * &lt;br&gt;injected properties are: log: { userName:&quot;andrea&quot;, remoteIp:&quot;127.0.0.1&quot;}
 *
 * &lt;br&gt;for instance, with the following definition:
 * &lt;br&gt;{name:&quot;addRequestProperties&quot;, &quot;phase&quot;:&quot;REQUEST&quot;, &quot;scope&quot;:&quot;CHILDREN&quot;,
 * args:[&quot;userName&quot;, &quot;remoteIp&quot;]}
 * &lt;br&gt;injected properties are: userName:&quot;andrea&quot;, remoteIp:&quot;127.0.0.1&quot;
 *
 */
<span class="nc" id="L63">public class RequestPropsInjecterTransformer implements Transformer {</span>
<span class="nc" id="L64">    static final Logger LOGGER = LoggerFactory.getLogger(RequestPropsInjecterTransformer.class);</span>

    /**
     *
     * @param exchange
     * @param context
     * @param contentToTransform
     * @param args properties to add
     */
    @Override
    public void tranform(final HttpServerExchange exchange, final RequestContext context, DBObject contentToTransform, final DBObject args) {
<span class="nc" id="L75">        BasicDBObject injected = new BasicDBObject();</span>

<span class="nc bnc" id="L77" title="All 2 branches missed.">        if (args instanceof BasicDBObject) {</span>
<span class="nc" id="L78">            HashMap&lt;String, Object&gt; properties = getPropsValues(exchange, context);</span>

<span class="nc" id="L80">            String firstKey = args.keySet().iterator().next();</span>

<span class="nc" id="L82">            Object _toinject = args.get(firstKey);</span>

<span class="nc bnc" id="L84" title="All 2 branches missed.">            if (_toinject instanceof BasicDBList) {</span>

<span class="nc" id="L86">                BasicDBList toinject = (BasicDBList) _toinject;</span>

<span class="nc" id="L88">                toinject.forEach(_el -&gt; {</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">                    if (_el instanceof String) {</span>
<span class="nc" id="L90">                        String el = (String) _el;</span>

<span class="nc" id="L92">                        Object value = properties.get(el);</span>

<span class="nc bnc" id="L94" title="All 2 branches missed.">                        if (value != null) {</span>
<span class="nc" id="L95">                            injected.put(el, value);</span>
                        } else {
<span class="nc" id="L97">                            context.addWarning(&quot;property in the args list does not have a value: &quot; + _el);</span>
                        }
<span class="nc" id="L99">                    } else {</span>
<span class="nc" id="L100">                        context.addWarning(&quot;property in the args list is not a string: &quot; + _el);</span>
                    }
<span class="nc" id="L102">                });</span>

<span class="nc" id="L104">                contentToTransform.put(firstKey, injected);</span>
<span class="nc" id="L105">            } else {</span>
<span class="nc" id="L106">                context.addWarning(&quot;transformer wrong definition: args must be an object with a array containing the names of the properties to inject. got &quot; + JsonUtils.serialize(args));</span>
            }
<span class="nc bnc" id="L108" title="All 2 branches missed.">        } else if (args instanceof BasicDBList) {</span>
<span class="nc" id="L109">            HashMap&lt;String, Object&gt; properties = getPropsValues(exchange, context);</span>

<span class="nc" id="L111">            BasicDBList toinject = (BasicDBList) args;</span>

<span class="nc" id="L113">            toinject.forEach(_el -&gt; {</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">                if (_el instanceof String) {</span>
<span class="nc" id="L115">                    String el = (String) _el;</span>

<span class="nc" id="L117">                    Object value = properties.get(el);</span>

<span class="nc bnc" id="L119" title="All 2 branches missed.">                    if (value != null) {</span>
<span class="nc" id="L120">                        injected.put(el, value);</span>
                    } else {
<span class="nc" id="L122">                        context.addWarning(&quot;property in the args list does not have a value: &quot; + _el);</span>
                    }
<span class="nc" id="L124">                } else {</span>
<span class="nc" id="L125">                    context.addWarning(&quot;property in the args list is not a string: &quot; + _el);</span>
                }
<span class="nc" id="L127">            });</span>

<span class="nc" id="L129">            contentToTransform.putAll((BSONObject) injected);</span>
<span class="nc" id="L130">        } else {</span>
<span class="nc" id="L131">            context.addWarning(&quot;transformer wrong definition: args must be an object with a array containing the names of the properties to inject. got &quot; + JsonUtils.serialize(args));</span>
        }
<span class="nc" id="L133">    }</span>

    HashMap&lt;String, Object&gt; getPropsValues(final HttpServerExchange exchange, final RequestContext context) {
<span class="nc" id="L136">        HashMap&lt;String, Object&gt; properties = new HashMap&lt;&gt;();</span>

        // remote user
<span class="nc" id="L139">        properties.put(&quot;userName&quot;, ExchangeAttributes.remoteUser().readAttribute(exchange));</span>

        // user roles
<span class="nc bnc" id="L142" title="All 2 branches missed.">        if (Objects.nonNull(exchange.getSecurityContext())</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">                &amp;&amp; Objects.nonNull(exchange.getSecurityContext().getAuthenticatedAccount())</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">                &amp;&amp; Objects.nonNull(exchange.getSecurityContext().getAuthenticatedAccount().getRoles())) {</span>
<span class="nc" id="L145">            properties.put(&quot;userRoles&quot;, exchange.getSecurityContext().getAuthenticatedAccount().getRoles().toString());</span>
        } else {
<span class="nc" id="L147">            properties.put(&quot;userRoles&quot;, null);</span>
        }

        // dateTime
<span class="nc" id="L151">        properties.put(&quot;epochTimeStamp&quot;, Instant.now().getEpochSecond());</span>

        // dateTime
<span class="nc" id="L154">        properties.put(&quot;dateTime&quot;, ExchangeAttributes.dateTime().readAttribute(exchange));</span>

        // local ip
<span class="nc" id="L157">        properties.put(&quot;localIp&quot;, ExchangeAttributes.localIp().readAttribute(exchange));</span>

        // local port
<span class="nc" id="L160">        properties.put(&quot;localPort&quot;, ExchangeAttributes.localPort().readAttribute(exchange));</span>

        // local server name
<span class="nc" id="L163">        properties.put(&quot;localServerName&quot;, ExchangeAttributes.localServerName().readAttribute(exchange));</span>

        // request query string
<span class="nc" id="L166">        properties.put(&quot;queryString&quot;, ExchangeAttributes.queryString().readAttribute(exchange));</span>

        // request relative path
<span class="nc" id="L169">        properties.put(&quot;relativePath&quot;, ExchangeAttributes.relativePath().readAttribute(exchange));</span>

        // remote ip
<span class="nc" id="L172">        properties.put(&quot;remoteIp&quot;, ExchangeAttributes.remoteIp().readAttribute(exchange));</span>

        // request method
<span class="nc" id="L175">        properties.put(&quot;requestMethod&quot;, ExchangeAttributes.requestMethod().readAttribute(exchange));</span>

        // request protocol
<span class="nc" id="L178">        properties.put(&quot;requestProtocol&quot;, ExchangeAttributes.requestProtocol().readAttribute(exchange));</span>

<span class="nc" id="L180">        return properties;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>